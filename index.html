<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Piano Metronome</title>
    <meta name="description" content="Advanced rhythm training for musicians with professional metronome features">
    <meta name="theme-color" content="#00d4ff">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0idXJsKCNncmFkaWVudDBfbGluZWFyXzFfMSkiLz4KPHBhdGggZD0iTTE2IDhDMTIuMzE0NyA4IDkgMTEuMzE0NyA5IDE1VjI0QzkgMjcuMzE0NyAxMi4zMTQ3IDMxIDE2IDMxQzE5LjY4NTMgMzEgMjMgMjcuMzE0NyAyMyAyNFYxNUMyMyAxMS4zMTQ3IDE5LjY4NTMgOCAxNiA4WiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTE2IDEwQzEzLjc5MDkgMTAgMTIgMTEuNzkwOSAxMiAxNFYyMkMxMiAyNC4yMDkxIDEzLjc5MDkgMjYgMTYgMjZDMThuMjA5MSAyNiAyMCAyNC4yMDkxIDIwIDIyVjE0QzIwIDExLjc5MDkgMTguMjA5MSAxMCAxNiAxMFoiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcl8yXzEpIi8+CjxwYXRoIGQ9Ik0xNiAxMkMxNC44OTU0IDEyIDE0IDEyLjg5NTQgMTQgMTRWMjJDMTRgMjMuMTA0NiAxNC44OTU0IDI0IDE2IDI0QzE3LjEwNDYgMjQgMTggMjMuMTA0NiAxOCAyMlYxNEMxOCAxMi44OTU0IDE3LjEwNDYgMTIgMTYgMTJaIiBmaWxsPSJ1cmwoI2dyYWRpZW50MF9saW5lYXJfM18xKSIvPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDBfbGluZWFyXzFfMSIgeDE9IjAiIHkxPSIwIiB4Mj0iMzIiIHkyPSIzMiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjMDBkNGZmIi8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iI2ZmNmI5ZCIvPgo8L2xpbmVhckdyYWRpZW50Pgo8bGluZWFyR3JhZGllbnQgaWQ9ImdyYWRpZW50MF9saW5lYXJfMl8xIiB4MT0iMTYiIHkxPSIxMCIgeDI9IjE2IiB5Mj0iMjYiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KPHN0b3Agc3RvcC1jb2xvcj0iIzAwZDRmZiIvPgo8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiNmZjZiOGRkIi8+CjwvbGluZWFyR3JhZGllbnQ+CjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQwX2xpbmVhcl8zXzEiIHgxPSIxNiIgeTE9IjEyIiB4Mj0iMTYiIHkyPSIyNCIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWN2b3I9IiMwMGQ0ZmYiLz4KPHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjZmY2YjlkIi8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPC9zdmc+">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #00d4ff, #ff6b9d, #ffd93d);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
        }

        .subtitle {
            font-size: 1.1rem;
            color: #b8bcc8;
            font-weight: 300;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            flex: 1;
        }

        .metronome-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .controls-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            height: fit-content;
        }

        .tempo-display {
            text-align: center;
            margin-bottom: 40px;
        }

        .bpm-value {
            font-size: 4rem;
            font-weight: 800;
            color: #00d4ff;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .bpm-label {
            font-size: 1.2rem;
            color: #b8bcc8;
            letter-spacing: 2px;
        }

        .visual-metronome {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            margin-bottom: 40px;
            position: relative;
        }

        .pendulum-container {
            width: 200px;
            height: 250px;
            position: relative;
        }

        .pendulum {
            width: 4px;
            height: 180px;
            background: linear-gradient(to bottom, #ff6b9d, #00d4ff);
            position: absolute;
            top: 40px;
            left: 50%;
            transform-origin: top center;
            transform: translateX(-50%) rotate(0deg);
            border-radius: 2px;
            box-shadow: 0 0 20px rgba(255, 107, 157, 0.4);
            transition: transform 0.1s ease-out;
        }

        .pendulum-bob {
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #ffd93d, #ff6b9d);
            border-radius: 50%;
            position: absolute;
            bottom: -10px;
            left: -8px;
            box-shadow: 0 0 20px rgba(255, 217, 61, 0.6);
        }

        .tempo-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .tempo-btn {
            background: linear-gradient(135deg, #ff6b9d, #8b5cf6);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(139, 92, 246, 0.3);
            transition: all 0.3s ease;
        }

        .tempo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(139, 92, 246, 0.4);
        }

        .tempo-slider {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .tempo-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #00d4ff, #ff6b9d);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        }

        .play-stop-btn {
            background: linear-gradient(135deg, #00d4ff, #0ea5e9);
            border: none;
            border-radius: 20px;
            padding: 15px 40px;
            color: white;
            font-size: 1.3rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 15px 30px rgba(0, 212, 255, 0.3);
            transition: all 0.3s ease;
            margin-bottom: 30px;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .play-stop-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(0, 212, 255, 0.4);
        }

        .play-stop-btn.playing {
            background: linear-gradient(135deg, #ff6b9d, #ef4444);
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #e2e8f0;
            font-size: 0.95rem;
        }

        .control-input, .control-select {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .control-input:focus, .control-select:focus {
            outline: none;
            border-color: #00d4ff;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .subdivision-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .subdivision-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .subdivision-btn.active {
            background: linear-gradient(135deg, #ffd93d, #ff6b9d);
            border-color: #ffd93d;
            box-shadow: 0 5px 15px rgba(255, 217, 61, 0.3);
        }

        .subdivision-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .tap-tempo-btn {
            background: linear-gradient(135deg, #ffd93d, #ff8c00);
            border: none;
            border-radius: 15px;
            padding: 15px;
            color: #1a1a2e;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(255, 217, 61, 0.3);
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 20px;
        }

        .tap-tempo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(255, 217, 61, 0.4);
        }

        .preset-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .preset-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 8px 12px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .beat-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .beat-dot {
            width: 15px;
            height: 15px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .beat-dot.active {
            background: linear-gradient(135deg, #00d4ff, #ff6b9d);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            transform: scale(1.3);
        }

        .beat-dot.accent {
            background: linear-gradient(135deg, #ffd93d, #ff6b9d);
        }

        .accent-pattern {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .accent-beat {
            width: 25px;
            height: 25px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .accent-beat.accent {
            background: linear-gradient(135deg, #ffd93d, #ff6b9d);
            border-color: #ffd93d;
        }

        /* Desktop improvements */
        @media (min-width: 1200px) {
            .container {
                max-width: 1400px;
                padding: 30px;
            }
            
            .main-grid {
                grid-template-columns: 1fr 400px;
                gap: 40px;
            }
            
            .metronome-section {
                padding: 50px;
            }
            
            .visual-metronome {
                height: 350px;
            }
            
            .pendulum-container {
                width: 240px;
                height: 300px;
            }
            
            .pendulum {
                height: 220px;
            }
        }

        /* Tablet - keep current design */
        @media (min-width: 769px) and (max-width: 1199px) {
            /* Current tablet design is perfect - no changes needed */
        }

        /* Mobile phone optimizations */
        @media (max-width: 768px) {
            body {
                background: linear-gradient(180deg, #0a0a0a 0%, #1a1a2e 100%);
            }
            
            .container {
                padding: 10px;
                max-width: 100%;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .header {
                padding: 15px;
                margin-bottom: 15px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .subtitle {
                font-size: 0.95rem;
            }
            
            .metronome-section {
                padding: 20px;
                border-radius: 20px;
                position: relative;
            }
            
            .controls-panel {
                padding: 20px;
                border-radius: 20px;
                position: fixed;
                top: 0;
                left: -320px;
                width: 300px;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
                overflow-y: auto;
                box-shadow: 5px 0 20px rgba(0, 0, 0, 0.5);
            }
            
            .controls-panel.open {
                left: 0;
            }
            
            .mobile-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }
            
            .mobile-overlay.active {
                display: block;
            }
            
            .mobile-controls-toggle {
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1001;
                background: linear-gradient(135deg, #00d4ff, #ff6b9d);
                border: none;
                border-radius: 50%;
                width: 50px;
                height: 50px;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .mobile-controls-toggle:hover {
                transform: scale(1.05);
            }
            
            .bpm-value {
                font-size: 2.8rem;
            }
            
            .visual-metronome {
                height: 220px;
                margin-bottom: 20px;
            }
            
            .pendulum-container {
                width: 150px;
                height: 180px;
            }
            
            .pendulum {
                height: 130px;
            }
            
            .tempo-controls {
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .tempo-btn {
                width: 60px;
                height: 60px;
                font-size: 1.8rem;
            }
            
            .play-stop-btn {
                padding: 20px;
                font-size: 1.5rem;
                border-radius: 25px;
                margin-bottom: 20px;
            }
            
            .beat-indicator {
                margin-bottom: 20px;
            }
            
            .beat-dot {
                width: 18px;
                height: 18px;
            }
            
            /* Larger controls for mobile */
            .control-input, .control-select {
                padding: 16px;
                font-size: 1.1rem;
                border-radius: 15px;
            }
            
            .control-label {
                font-size: 1.1rem;
                margin-bottom: 12px;
            }
            
            .subdivision-btn {
                padding: 15px;
                font-size: 1rem;
                border-radius: 12px;
            }
            
            .tap-tempo-btn {
                padding: 20px;
                font-size: 1.2rem;
                border-radius: 18px;
            }
            
            .preset-btn {
                padding: 12px 16px;
                font-size: 1rem;
            }
            
            .tempo-preset-btn {
                padding: 12px;
                font-size: 0.95rem;
            }
            
            .accent-beat {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            .controls-panel .control-group:last-child {
                margin-bottom: 80px; /* Space for bottom navigation */
            }
        }

        /* Hide mobile controls on desktop */
        .mobile-controls-toggle {
            display: none;
        }
        
        .mobile-overlay {
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-controls-toggle {
                display: flex;
            }
        }

        .advanced-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .polyrhythm-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .tempo-presets {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .tempo-preset-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tempo-preset-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Mobile controls toggle -->
        <button class="mobile-controls-toggle" onclick="toggleMobileControls()" aria-label="Open metronome controls">
            ⚙️
        </button>
        
        <!-- Mobile overlay -->
        <div class="mobile-overlay" onclick="closeMobileControls()"></div>
        
        <div class="header">
            <h1>Professional Piano Metronome</h1>
            <p class="subtitle">Advanced rhythm training for musicians</p>
        </div>

        <div class="main-grid">
            <div class="metronome-section">
                <div class="tempo-display">
                    <div class="bpm-value" id="bpmDisplay">120</div>
                    <div class="bpm-label">BPM</div>
                </div>

                <div class="visual-metronome">
                    <div class="pendulum-container">
                        <div class="pendulum" id="pendulum">
                            <div class="pendulum-bob"></div>
                        </div>
                    </div>
                </div>

                <div class="beat-indicator" id="beatIndicator">
                    <div class="beat-dot"></div>
                    <div class="beat-dot"></div>
                    <div class="beat-dot"></div>
                    <div class="beat-dot"></div>
                </div>

                <div class="tempo-controls">
                    <button class="tempo-btn" onclick="adjustTempo(-5)">−</button>
                    <input type="range" class="tempo-slider" id="tempoSlider" min="40" max="208" value="120">
                    <button class="tempo-btn" onclick="adjustTempo(5)">+</button>
                </div>

                <button class="play-stop-btn" id="playStopBtn" onclick="toggleMetronome()">START</button>
            </div>

            <div class="controls-panel">
                <div class="control-group">
                    <label class="control-label">Time Signature</label>
                    <select class="control-select" id="timeSignature">
                        <option value="4/4">4/4</option>
                        <option value="3/4">3/4</option>
                        <option value="2/4">2/4</option>
                        <option value="6/8">6/8</option>
                        <option value="9/8">9/8</option>
                        <option value="12/8">12/8</option>
                        <option value="5/4">5/4</option>
                        <option value="7/8">7/8</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label">Subdivisions</label>
                    <div class="subdivision-grid">
                        <button class="subdivision-btn active" data-subdivision="quarter">♩ Quarter</button>
                        <button class="subdivision-btn" data-subdivision="eighth">♫ Eighth</button>
                        <button class="subdivision-btn" data-subdivision="triplet">♫♫♫ Triplet</button>
                        <button class="subdivision-btn" data-subdivision="sixteenth">♬ Sixteenth</button>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">Sound</label>
                    <select class="control-select" id="soundSelect">
                        <option value="classic">Classic Click</option>
                        <option value="wood">Wood Block</option>
                        <option value="digital">Digital Beep</option>
                        <option value="cowbell">Cowbell</option>
                        <option value="rimshot">Rimshot</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label">Volume</label>
                    <input type="range" class="control-input" id="volumeSlider" min="0" max="100" value="70">
                </div>

                <button class="tap-tempo-btn" onclick="tapTempo()">TAP TEMPO</button>

                <div class="control-group">
                    <label class="control-label">Accent Pattern</label>
                    <div class="accent-pattern" id="accentPattern"></div>
                </div>

                <div class="preset-controls">
                    <button class="preset-btn" onclick="savePreset()">Save</button>
                    <button class="preset-btn" onclick="loadPreset()">Load</button>
                </div>

                <div class="advanced-section">
                    <div class="control-group">
                        <label class="control-label">Keyboard Shortcuts</label>
                        <div style="font-size: 0.85rem; color: #b8bcc8; line-height: 1.4;">
                            <div><strong>Space:</strong> Start/Stop</div>
                            <div><strong>↑/↓:</strong> Fine tempo (±1)</div>
                            <div><strong>←/→:</strong> Coarse tempo (±5)</div>
                            <div><strong>T, Q, W, E, R, Enter:</strong> Tap tempo</div>
                            <div style="margin-top: 8px; font-size: 0.8rem; opacity: 0.8;">
                                On mobile: Tap the gear icon to access controls
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">Tempo Presets</label>
                        <div class="tempo-presets">
                            <button class="tempo-preset-btn" onclick="setTempo(60)">Largo (60)</button>
                            <button class="tempo-preset-btn" onclick="setTempo(76)">Adagio (76)</button>
                            <button class="tempo-preset-btn" onclick="setTempo(108)">Andante (108)</button>
                            <button class="tempo-preset-btn" onclick="setTempo(120)">Moderato (120)</button>
                            <button class="tempo-preset-btn" onclick="setTempo(144)">Allegro (144)</button>
                            <button class="tempo-preset-btn" onclick="setTempo(180)">Presto (180)</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Polyrhythm</label>
                        <div class="polyrhythm-controls">
                            <input type="number" class="control-input" id="polyLeft" placeholder="3" min="2" max="16">
                            <input type="number" class="control-input" id="polyRight" placeholder="4" min="2" max="16">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ProfessionalMetronome {
            constructor() {
                this.isPlaying = false;
                this.bpm = 120;
                this.currentBeat = 0;
                this.beatsPerMeasure = 4;
                this.subdivision = 'quarter';
                this.accentPattern = [true, false, false, false];
                this.volume = 0.7;
                this.sound = 'classic';
                this.audioContext = null;
                this.nextNoteTime = 0.0;
                this.scheduleAheadTime = 25.0;
                this.lookAhead = 25.0;
                this.timerInterval = null;
                this.tapTimes = [];
                
                this.initializeAudio();
                this.initializeTimer();
                this.setupEventListeners();
                this.updateBeatIndicator();
                this.updateAccentPattern();
            }

            initializeAudio() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            initializeTimer() {
                // Use setInterval instead of Worker for better compatibility
                this.timerInterval = null;
            }

            createSound(frequency = 800, duration = 0.1, type = 'sine') {
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(this.volume, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            playSound(isAccent = false) {
                const soundSettings = {
                    'classic': { freq: isAccent ? 1000 : 800, duration: 0.1, type: 'sine' },
                    'wood': { freq: isAccent ? 400 : 200, duration: 0.15, type: 'triangle' },
                    'digital': { freq: isAccent ? 1200 : 800, duration: 0.08, type: 'square' },
                    'cowbell': { freq: isAccent ? 800 : 600, duration: 0.2, type: 'triangle' },
                    'rimshot': { freq: isAccent ? 300 : 200, duration: 0.05, type: 'sawtooth' }
                };
                
                const settings = soundSettings[this.sound] || soundSettings['classic'];
                this.createSound(settings.freq, settings.duration, settings.type);
            }

            scheduler() {
                while (this.nextNoteTime < this.audioContext.currentTime + this.scheduleAheadTime / 1000.0) {
                    this.scheduleNote(this.nextNoteTime);
                    this.nextNote();
                }
            }

            scheduleNote(time) {
                const isAccent = this.accentPattern[this.currentBeat % this.accentPattern.length];
                
                // Schedule the sound
                setTimeout(() => {
                    this.playSound(isAccent);
                    this.updateVisualFeedback();
                }, (time - this.audioContext.currentTime) * 1000);
            }

            nextNote() {
                const secondsPerBeat = 60.0 / this.bpm;
                let subdivisionMultiplier = 1;
                
                switch(this.subdivision) {
                    case 'eighth': subdivisionMultiplier = 0.5; break;
                    case 'triplet': subdivisionMultiplier = 1/3; break;
                    case 'sixteenth': subdivisionMultiplier = 0.25; break;
                }
                
                this.nextNoteTime += secondsPerBeat * subdivisionMultiplier;
                this.currentBeat++;
            }

            updateVisualFeedback() {
                // Update beat indicator
                const beatDots = document.querySelectorAll('.beat-dot');
                beatDots.forEach((dot, index) => {
                    dot.classList.remove('active', 'accent');
                    if (index === this.currentBeat % this.beatsPerMeasure) {
                        dot.classList.add('active');
                        if (this.accentPattern[index]) {
                            dot.classList.add('accent');
                        }
                    }
                });

                // Update pendulum
                const pendulum = document.getElementById('pendulum');
                const angle = this.currentBeat % 2 === 0 ? 20 : -20;
                pendulum.style.transform = `translateX(-50%) rotate(${angle}deg)`;
            }

            start() {
                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
                
                this.isPlaying = true;
                this.currentBeat = 0;
                this.nextNoteTime = this.audioContext.currentTime;
                
                // Start the scheduler with requestAnimationFrame for better performance
                this.scheduleLoop();
                
                document.getElementById('playStopBtn').textContent = 'STOP';
                document.getElementById('playStopBtn').classList.add('playing');
            }

            scheduleLoop() {
                if (this.isPlaying) {
                    this.scheduler();
                    // Use setTimeout for consistent timing, fallback to requestAnimationFrame
                    setTimeout(() => this.scheduleLoop(), 25);
                }
            }

            stop() {
                this.isPlaying = false;
                
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
                
                document.getElementById('playStopBtn').textContent = 'START';
                document.getElementById('playStopBtn').classList.remove('playing');
                
                // Reset visual indicators
                document.querySelectorAll('.beat-dot').forEach(dot => {
                    dot.classList.remove('active', 'accent');
                });
                
                document.getElementById('pendulum').style.transform = 'translateX(-50%) rotate(0deg)';
            }

            setTempo(newTempo) {
                this.bpm = Math.max(40, Math.min(208, newTempo));
                document.getElementById('bpmDisplay').textContent = this.bpm;
                document.getElementById('tempoSlider').value = this.bpm;
            }

            setTimeSignature(signature) {
                const [beats, noteValue] = signature.split('/').map(Number);
                this.beatsPerMeasure = beats;
                this.updateBeatIndicator();
                this.updateAccentPattern();
            }

            updateBeatIndicator() {
                const indicator = document.getElementById('beatIndicator');
                indicator.innerHTML = '';
                
                for (let i = 0; i < this.beatsPerMeasure; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'beat-dot';
                    indicator.appendChild(dot);
                }
            }

            updateAccentPattern() {
                this.accentPattern = new Array(this.beatsPerMeasure).fill(false);
                this.accentPattern[0] = true; // First beat is always accented
                
                const patternDiv = document.getElementById('accentPattern');
                patternDiv.innerHTML = '';
                
                for (let i = 0; i < this.beatsPerMeasure; i++) {
                    const beat = document.createElement('div');
                    beat.className = 'accent-beat';
                    beat.textContent = i + 1;
                    if (this.accentPattern[i]) {
                        beat.classList.add('accent');
                    }
                    
                    beat.addEventListener('click', () => {
                        this.accentPattern[i] = !this.accentPattern[i];
                        beat.classList.toggle('accent');
                    });
                    
                    patternDiv.appendChild(beat);
                }
            }

            setupEventListeners() {
                // Tempo slider
                document.getElementById('tempoSlider').addEventListener('input', (e) => {
                    this.setTempo(parseInt(e.target.value));
                });

                // Time signature
                document.getElementById('timeSignature').addEventListener('change', (e) => {
                    this.setTimeSignature(e.target.value);
                });

                // Subdivisions
                document.querySelectorAll('.subdivision-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.subdivision-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.subdivision = e.target.dataset.subdivision;
                    });
                });

                // Sound selection
                document.getElementById('soundSelect').addEventListener('change', (e) => {
                    this.sound = e.target.value;
                });

                // Volume control
                document.getElementById('volumeSlider').addEventListener('input', (e) => {
                    this.volume = e.target.value / 100;
                });

                // Polyrhythm controls
                document.getElementById('polyLeft').addEventListener('input', (e) => {
                    this.setupPolyrhythm();
                });

                document.getElementById('polyRight').addEventListener('input', (e) => {
                    this.setupPolyrhythm();
                });
            }

            setupPolyrhythm() {
                const left = parseInt(document.getElementById('polyLeft').value) || 3;
                const right = parseInt(document.getElementById('polyRight').value) || 4;
                
                // Calculate LCM for polyrhythm pattern
                const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                const lcm = (a, b) => (a * b) / gcd(a, b);
                
                const patternLength = lcm(left, right);
                this.polyrhythmPattern = [];
                
                for (let i = 0; i < patternLength; i++) {
                    const leftHit = i % (patternLength / left) === 0;
                    const rightHit = i % (patternLength / right) === 0;
                    this.polyrhythmPattern.push({ left: leftHit, right: rightHit });
                }
            }

            tapTempo() {
                const now = Date.now();
                this.tapTimes.push(now);
                
                // Keep only last 4 taps
                if (this.tapTimes.length > 4) {
                    this.tapTimes.shift();
                }
                
                if (this.tapTimes.length >= 2) {
                    const intervals = [];
                    for (let i = 1; i < this.tapTimes.length; i++) {
                        intervals.push(this.tapTimes[i] - this.tapTimes[i-1]);
                    }
                    
                    const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;
                    const newBpm = Math.round(60000 / avgInterval);
                    
                    if (newBpm >= 40 && newBpm <= 208) {
                        this.setTempo(newBpm);
                    }
                }
                
                // Clear taps after 3 seconds of inactivity
                setTimeout(() => {
                    const timeSinceLastTap = Date.now() - now;
                    if (timeSinceLastTap >= 3000) {
                        this.tapTimes = [];
                    }
                }, 3000);
            }

            savePreset() {
                const preset = {
                    bpm: this.bpm,
                    timeSignature: document.getElementById('timeSignature').value,
                    subdivision: this.subdivision,
                    sound: this.sound,
                    volume: this.volume,
                    accentPattern: [...this.accentPattern]
                };
                
                const name = prompt('Enter preset name:');
                if (name) {
                    localStorage.setItem(`metronome-preset-${name}`, JSON.stringify(preset));
                    alert('Preset saved successfully!');
                }
            }

            loadPreset() {
                const name = prompt('Enter preset name to load:');
                if (name) {
                    const presetData = localStorage.getItem(`metronome-preset-${name}`);
                    if (presetData) {
                        const preset = JSON.parse(presetData);
                        
                        this.setTempo(preset.bpm);
                        document.getElementById('timeSignature').value = preset.timeSignature;
                        this.setTimeSignature(preset.timeSignature);
                        this.subdivision = preset.subdivision;
                        this.sound = preset.sound;
                        this.volume = preset.volume;
                        
                        document.getElementById('soundSelect').value = preset.sound;
                        document.getElementById('volumeSlider').value = preset.volume * 100;
                        
                        // Update subdivision buttons
                        document.querySelectorAll('.subdivision-btn').forEach(btn => {
                            btn.classList.remove('active');
                            if (btn.dataset.subdivision === preset.subdivision) {
                                btn.classList.add('active');
                            }
                        });
                        
                        alert('Preset loaded successfully!');
                    } else {
                        alert('Preset not found!');
                    }
                }
            }
        }

        // Global functions
        let metronome;

        function initializeMetronome() {
            metronome = new ProfessionalMetronome();
        }

        function toggleMetronome() {
            if (!metronome) {
                initializeMetronome();
            }
            
            if (metronome.isPlaying) {
                metronome.stop();
            } else {
                metronome.start();
            }
        }

        function adjustTempo(change) {
            if (!metronome) {
                initializeMetronome();
            }
            metronome.setTempo(metronome.bpm + change);
        }

        function setTempo(bpm) {
            if (!metronome) {
                initializeMetronome();
            }
            metronome.setTempo(bpm);
        }

        function tapTempo() {
            if (!metronome) {
                initializeMetronome();
            }
            metronome.tapTempo();
        }

        function savePreset() {
            if (!metronome) {
                initializeMetronome();
            }
            metronome.savePreset();
        }

        function loadPreset() {
            if (!metronome) {
                initializeMetronome();
            }
            metronome.loadPreset();
        }

        // Mobile controls functions
        function toggleMobileControls() {
            const panel = document.querySelector('.controls-panel');
            const overlay = document.querySelector('.mobile-overlay');
            const button = document.querySelector('.mobile-controls-toggle');
            
            if (panel.classList.contains('open')) {
                closeMobileControls();
            } else {
                panel.classList.add('open');
                overlay.classList.add('active');
                button.style.left = '320px';
            }
        }

        function closeMobileControls() {
            const panel = document.querySelector('.controls-panel');
            const overlay = document.querySelector('.mobile-overlay');
            const button = document.querySelector('.mobile-controls-toggle');
            
            panel.classList.remove('open');
            overlay.classList.remove('active');
            button.style.left = '20px';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Add click handlers for tempo preset buttons
            document.querySelectorAll('.tempo-preset-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const bpm = parseInt(e.target.textContent.match(/\d+/)[0]);
                    setTempo(bpm);
                });
            });

            // Add visual feedback for button interactions
            document.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.target.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        e.target.style.transform = '';
                    }, 150);
                });
            });

            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Prevent default only for our shortcuts
                switch(e.code) {
                    case 'Space':
                        e.preventDefault();
                        toggleMetronome();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        adjustTempo(1);
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        adjustTempo(-1);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        adjustTempo(5);
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        adjustTempo(-5);
                        break;
                    case 'KeyT':
                        if (!e.ctrlKey && !e.altKey && !e.metaKey) {
                            e.preventDefault();
                            tapTempo();
                        }
                        break;
                    case 'KeyQ':
                        if (!e.ctrlKey && !e.altKey && !e.metaKey) {
                            e.preventDefault();
                            tapTempo();
                        }
                        break;
                    case 'KeyW':
                        if (!e.ctrlKey && !e.altKey && !e.metaKey) {
                            e.preventDefault();
                            tapTempo();
                        }
                        break;
                    case 'KeyE':
                        if (!e.ctrlKey && !e.altKey && !e.metaKey) {
                            e.preventDefault();
                            tapTempo();
                        }
                        break;
                    case 'KeyR':
                        if (!e.ctrlKey && !e.altKey && !e.metaKey) {
                            e.preventDefault();
                            tapTempo();
                        }
                        break;
                    case 'Enter':
                        if (!e.ctrlKey && !e.altKey && !e.metaKey) {
                            e.preventDefault();
                            tapTempo();
                        }
                        break;
                    case 'Escape':
                        if (window.innerWidth <= 768) {
                            closeMobileControls();
                        }
                        break;
                }
            });

            // Add visual feedback for tap tempo keys
            const tapKeys = ['KeyT', 'KeyQ', 'KeyW', 'KeyE', 'KeyR', 'Enter'];
            document.addEventListener('keydown', (e) => {
                if (tapKeys.includes(e.code)) {
                    const tapButton = document.querySelector('.tap-tempo-btn');
                    if (tapButton) {
                        tapButton.style.transform = 'scale(0.95)';
                        tapButton.style.background = 'linear-gradient(135deg, #ff6b9d, #ffd93d)';
                    }
                }
            });

            document.addEventListener('keyup', (e) => {
                if (tapKeys.includes(e.code)) {
                    const tapButton = document.querySelector('.tap-tempo-btn');
                    if (tapButton) {
                        setTimeout(() => {
                            tapButton.style.transform = '';
                            tapButton.style.background = '';
                        }, 150);
                    }
                }
            });

            // Initialize the metronome
            initializeMetronome();
        });

        // Handle visibility change to pause when tab is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && metronome && metronome.isPlaying) {
                // Optionally pause when tab is hidden
                // metronome.stop();
            }
        });
        // Register service worker for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {});
            });
        }
    </script>
</body>
</html>