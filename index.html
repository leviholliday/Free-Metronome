<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Piano Metronome</title>
    <meta name="description" content="Advanced rhythm training for musicians with professional metronome features">
    <meta name="theme-color" content="#00d4ff">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0idXJsKCNncmFkaWVudDBfbGluZWFyXzFfMSkiLz4KPHBhdGggZD0iTTE2IDhDMTIuMzE0NyA4IDkgMTEuMzE0NyA5IDE1VjI0QzkgMjcuMzE0NyAxMi4zMTQ3IDMxIDE2IDMxQzE5LjY4NTMgMzEgMjMgMjcuMzE0NyAyMyAyNFYxNUMyMyAxMS4zMTQ3IDE5LjY4NTMgOCAxNiA4WiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTE2IDEwQzEzLjc5MDkgMTAgMTIgMTEuNzkwOSAxMiAxNFYyMkMxMiAyNC4yMDkxIDEzLjc5MDkgMjYgMTYgMjZDMThuMjA5MSAyNiAyMCAyNC4yMDkxIDIwIDIyVjE0QzIwIDExLjc5MDkgMTguMjA5MSAxMCAxNiAxMFoiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcl8yXzEpIi8+CjxwYXRoIGQ9Ik0xNiAxMkMxNC44OTU0IDEyIDE0IDEyLjg5NTQgMTQgMTRWMjJDMTRgMjMuMTA0NiAxNC44OTU0IDI0IDE2IDI0QzE3LjEwNDYgMjQgMTggMjMuMTA0NiAxOCAyMlYxNEMxOCAxMi44OTU0IDE3LjEwNDYgMTIgMTYgMTJaIiBmaWxsPSJ1cmwoI2dyYWRpZW50MF9saW5lYXJfM18xKSIvPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDBfbGluZWFyXzFfMSIgeDE9IjAiIHkxPSIwIiB4Mj0iMzIiIHkyPSIzMiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjMDBkNGZmIi8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iI2ZmNmI5ZCIvPgo8L2xpbmVhckdyYWRpZW50Pgo8bGluZWFyR3JhZGllbnQgaWQ9ImdyYWRpZW50MF9saW5lYXJfMl8xIiB4MT0iMTYiIHkxPSIxMCIgeDI9IjE2IiB5Mj0iMjYiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KPHN0b3Agc3RvcC1jb2xvcj0iIzAwZDRmZiIvPgo8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiNmZjZiOGRkIi8+CjwvbGluZWFyR3JhZGllbnQ+CjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQwX2xpbmVhcl8zXzEiIHgxPSIxNiIgeTE9IjEyIiB4Mj0iMTYiIHkyPSIyNCIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWN2b3I9IiMwMGQ0ZmYiLz4KPHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjZmY2YjlkIi8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPC9zdmc+">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #00d4ff, #ff6b9d, #ffd93d);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
        }

        .subtitle {
            font-size: 1.1rem;
            color: #b8bcc8;
            font-weight: 300;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            flex: 1;
        }

        .side-column { display: flex; flex-direction: column; gap: 20px; height: fit-content; }
        .timer-panel { background: rgba(255,255,255,0.05); backdrop-filter: blur(15px); border-radius: 25px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px rgba(0,0,0,0.3); }

        .metronome-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .controls-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            height: fit-content;
        }

        /* Keep side controls visible on desktop */
        @media (min-width: 769px) {
            .controls-panel {
                position: sticky;
                top: 20px;
            }
        }

        .tempo-display {
            text-align: center;
            margin-bottom: 40px;
        }

        .bpm-value {
            font-size: 4rem;
            font-weight: 800;
            color: #00d4ff;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .bpm-label {
            font-size: 1.2rem;
            color: #b8bcc8;
            letter-spacing: 2px;
        }

        .visual-metronome {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            margin-bottom: 40px;
            position: relative;
        }

        .pendulum-container {
            width: 200px;
            height: 250px;
            position: relative;
        }

        .pendulum {
            width: 5px;
            height: 190px;
            background: linear-gradient(to bottom, rgba(255,107,157,0.9), rgba(0,212,255,0.9));
            position: absolute;
            top: 40px;
            left: 50%;
            transform-origin: top center;
            transform: translateX(-50%) rotate(0deg);
            border-radius: 2px;
            box-shadow: 0 0 24px rgba(0, 212, 255, 0.35), 0 0 10px rgba(255, 107, 157, 0.25);
            transition: transform 0.1s ease-out;
        }

        .pendulum-bob {
            width: 24px;
            height: 24px;
            background: radial-gradient(circle at 40% 35%, #fff2a8, #ffd93d 40%, #ff6b9d 70%);
            border-radius: 50%;
            position: absolute;
            bottom: -10px;
            left: -10px;
            box-shadow: 0 0 24px rgba(255, 217, 61, 0.65);
        }

        .pendulum-glow {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 180px;
            height: 240px;
            background: radial-gradient(ellipse at 50% 10%, rgba(0,212,255,0.18), rgba(0,212,255,0) 60%);
            filter: blur(8px);
            opacity: 0.55;
            pointer-events: none;
        }

        .tempo-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .tempo-input {
            width: 90px;
            text-align: center;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.18);
            color: #fff;
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 1rem;
        }

        .tempo-btn {
            background: linear-gradient(135deg, #ff6b9d, #8b5cf6);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(139, 92, 246, 0.3);
            transition: all 0.3s ease;
        }

        .tempo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(139, 92, 246, 0.4);
        }

        .tempo-slider {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .tempo-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #00d4ff, #ff6b9d);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        }

        .play-stop-btn {
            background: linear-gradient(135deg, #00d4ff, #0ea5e9);
            border: none;
            border-radius: 20px;
            padding: 15px 40px;
            color: white;
            font-size: 1.3rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 15px 30px rgba(0, 212, 255, 0.3);
            transition: all 0.3s ease;
            margin-bottom: 30px;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .play-stop-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(0, 212, 255, 0.4);
        }

        .play-stop-btn.playing {
            background: linear-gradient(135deg, #ff6b9d, #ef4444);
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #e2e8f0;
            font-size: 0.95rem;
        }

        .control-input, .control-select {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        /* Enhanced select styling */
        .control-select {
            appearance: none;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.18);
            position: relative;
            padding-right: 44px;
        }
        .control-select-wrapper {
            position: relative;
        }
        .control-select-wrapper::after {
            content: '';
            position: absolute;
            right: 14px;
            top: 50%;
            width: 10px;
            height: 10px;
            transform: translateY(-50%) rotate(45deg);
            border-right: 2px solid #b8bcc8;
            border-bottom: 2px solid #b8bcc8;
            opacity: 0.9;
            pointer-events: none;
        }
        .control-select:hover { background: rgba(255, 255, 255, 0.12); }

        .control-input:focus, .control-select:focus {
            outline: none;
            border-color: #00d4ff;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .subdivision-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .subdivision-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .subdivision-btn.active {
            background: linear-gradient(135deg, #ffd93d, #ff6b9d);
            border-color: #ffd93d;
            box-shadow: 0 5px 15px rgba(255, 217, 61, 0.3);
        }

        .subdivision-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .tap-tempo-btn {
            background: linear-gradient(135deg, #ffd93d, #ff8c00);
            border: none;
            border-radius: 15px;
            padding: 15px;
            color: #1a1a2e;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(255, 217, 61, 0.3);
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 20px;
        }

        .tap-tempo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(255, 217, 61, 0.4);
        }

        .preset-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .preset-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 8px 12px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .beat-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .beat-dot {
            width: 15px;
            height: 15px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .beat-dot.active {
            background: linear-gradient(135deg, #00d4ff, #ff6b9d);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            transform: scale(1.3);
        }

        .beat-dot.accent {
            background: linear-gradient(135deg, #ffd93d, #ff6b9d);
        }

        .accent-pattern {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .accent-beat {
            width: 25px;
            height: 25px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .accent-beat.accent {
            background: linear-gradient(135deg, #ffd93d, #ff6b9d);
            border-color: #ffd93d;
        }

        /* Desktop improvements */
        @media (min-width: 1200px) {
            .container {
                max-width: 1400px;
                padding: 30px;
            }
            
            .main-grid {
                grid-template-columns: 1fr 400px;
                gap: 40px;
            }
            
            .metronome-section {
                padding: 50px;
            }
            
            .visual-metronome {
                height: 350px;
            }
            
            .pendulum-container {
                width: 240px;
                height: 300px;
            }
            
            .pendulum {
                height: 220px;
            }
        }

        /* Tablet - keep current design */
        @media (min-width: 769px) and (max-width: 1199px) {
            /* Current tablet design is perfect - no changes needed */
        }

        /* Mobile phone optimizations */
        @media (max-width: 768px) {
            body {
                background: linear-gradient(180deg, #0a0a0a 0%, #1a1a2e 100%);
            }
            
            .container {
                padding: 10px;
                max-width: 100%;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .header {
                padding: 15px;
                margin-bottom: 15px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .subtitle {
                font-size: 0.95rem;
            }
            
            .metronome-section {
                padding: 20px;
                border-radius: 20px;
                position: relative;
            }
            
            .controls-panel {
                padding: 20px;
                border-radius: 20px;
                position: fixed;
                top: 0;
                left: -320px;
                width: 300px;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
                overflow-y: auto;
                box-shadow: 5px 0 20px rgba(0, 0, 0, 0.5);
            }
            
            .controls-panel.open {
                left: 0;
            }
            
            .mobile-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }
            
            .mobile-overlay.active {
                display: block;
            }
            
            .mobile-controls-toggle {
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1001;
                background: linear-gradient(135deg, #00d4ff, #ff6b9d);
                border: none;
                border-radius: 50%;
                width: 50px;
                height: 50px;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .mobile-controls-toggle:hover {
                transform: scale(1.05);
            }
            
            .bpm-value {
                font-size: 2.8rem;
            }
            
            .visual-metronome {
                height: 220px;
                margin-bottom: 20px;
            }
            
            .pendulum-container {
                width: 150px;
                height: 180px;
            }
            
            .pendulum {
                height: 130px;
            }
            
            .tempo-controls {
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .tempo-btn {
                width: 60px;
                height: 60px;
                font-size: 1.8rem;
            }
            
            .play-stop-btn {
                padding: 20px;
                font-size: 1.5rem;
                border-radius: 25px;
                margin-bottom: 20px;
            }
            
            .beat-indicator {
                margin-bottom: 20px;
            }
            
            .beat-dot {
                width: 18px;
                height: 18px;
            }
            
            /* Larger controls for mobile */
            .control-input, .control-select {
                padding: 16px;
                font-size: 1.1rem;
                border-radius: 15px;
            }
            
            .control-label {
                font-size: 1.1rem;
                margin-bottom: 12px;
            }
            
            .subdivision-btn {
                padding: 15px;
                font-size: 1rem;
                border-radius: 12px;
            }
            
            .tap-tempo-btn {
                padding: 20px;
                font-size: 1.2rem;
                border-radius: 18px;
            }
            
            .preset-btn {
                padding: 12px 16px;
                font-size: 1rem;
            }
            
            .tempo-preset-btn {
                padding: 12px;
                font-size: 0.95rem;
            }
            
            .accent-beat {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            .controls-panel .control-group:last-child {
                margin-bottom: 80px; /* Space for bottom navigation */
            }
        }

        /* Hide mobile controls on desktop */
        .mobile-controls-toggle {
            display: none;
        }
        
        .mobile-overlay {
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-controls-toggle {
                display: flex;
            }
        }

        .advanced-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .polyrhythm-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .tempo-presets {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .tempo-preset-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tempo-preset-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        /* Theme segmented control */
        .theme-group {
            display: flex;
            gap: 8px;
            background: rgba(255, 255, 255, 0.06);
            padding: 6px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.12);
        }
        .theme-option {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 12px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid transparent;
            color: #ffffff;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 240ms ease, transform 240ms ease, box-shadow 240ms ease, border-color 240ms ease;
        }
        .theme-option:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-1px);
        }
        .theme-option.selected {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            border-color: rgba(255, 255, 255, 0.25);
        }
        .theme-option .icon { font-size: 1.1rem; }

        /* Selected theme hints */
        .theme-option.selected.theme-ocean {
            background: linear-gradient(135deg, rgba(0,212,255,0.18), rgba(139,92,246,0.18));
        }
        .theme-option.selected.theme-sunset {
            background: linear-gradient(135deg, rgba(255,107,157,0.18), rgba(255,138,91,0.18));
        }
        .theme-option.selected.theme-aurora {
            background: linear-gradient(135deg, rgba(126,249,197,0.18), rgba(0,212,255,0.18));
        }

        /* 3D cards + depth */
        .card-3d {
            transform-style: preserve-3d;
            transition: transform 300ms ease, box-shadow 300ms ease;
            box-shadow:
                0 1px 2px rgba(0,0,0,0.18),
                0 8px 24px rgba(0,0,0,0.28);
            will-change: transform;
        }
        .card-3d:hover {
            box-shadow:
                0 2px 6px rgba(0,0,0,0.2),
                0 18px 48px rgba(0,0,0,0.35);
        }

        /* Beat pulse */
        @keyframes glowPulse {
            0% { box-shadow: 0 0 0px rgba(0,212,255,0.0); }
            50% { box-shadow: 0 0 24px rgba(0,212,255,0.35); }
            100% { box-shadow: 0 0 0px rgba(0,212,255,0.0); }
        }
        .beat-dot.pulse { animation: glowPulse 280ms ease-out; }

        /* Beat ripple and flash */
        .bpm-ripple {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            animation: rippleExpand 700ms ease-out forwards;
            background: radial-gradient(circle, rgba(0,212,255,0.45), rgba(0,212,255,0) 60%);
            filter: blur(2px);
        }
        @keyframes rippleExpand {
            0% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(8); }
        }
        .metronome-section.beat-flash { box-shadow: 0 0 40px rgba(0,212,255,0.35), 0 25px 50px rgba(0,0,0,0.3); }

        /* Subtle animated background orbs */
        .bg-orbs {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }
        /* Subtle global hue shift for atmosphere */
        @keyframes hueShift {
            0% { filter: hue-rotate(-6deg) saturate(105%); }
            50% { filter: hue-rotate(6deg) saturate(110%); }
            100% { filter: hue-rotate(-6deg) saturate(105%); }
        }
        .bg-orbs { animation: hueShift 180s ease-in-out infinite alternate; }

        /* Fullscreen themed backgrounds */
        .fullscreen-theme-bg, .fs-theme-bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            opacity: 0;
            transition: opacity 400ms ease;
            background-size: cover;
            background-position: center;
            filter: saturate(110%);
        }
        body.fullscreen-active .fullscreen-theme-bg { opacity: 1; }
        /* When the metronome panel is fullscreen, use internal bg */
        .metronome-section .fs-theme-bg { position: absolute; border-radius: 25px; }
        body.fullscreen-active .metronome-section .fs-theme-bg { opacity: 1; }
        /* Ocean */
        body.fullscreen-active:not(.theme-sunset):not(.theme-aurora) .fullscreen-theme-bg,
        body.fullscreen-active:not(.theme-sunset):not(.theme-aurora) .metronome-section .fs-theme-bg {
            background-image:
                radial-gradient(1200px 800px at 70% 20%, rgba(0,212,255,0.18), rgba(0,212,255,0) 60%),
                radial-gradient(1000px 700px at 20% 80%, rgba(0,120,255,0.12), rgba(0,120,255,0) 60%),
                linear-gradient(135deg, #04131a, #0a2740 40%, #062034);
        }
        /* Sunset */
        body.fullscreen-active.theme-sunset .fullscreen-theme-bg,
        body.fullscreen-active.theme-sunset .metronome-section .fs-theme-bg {
            background-image:
                radial-gradient(1200px 800px at 70% 20%, rgba(255,107,157,0.22), rgba(255,107,157,0) 60%),
                radial-gradient(1000px 700px at 20% 80%, rgba(255,165,0,0.18), rgba(255,165,0,0) 60%),
                linear-gradient(135deg, #1a0b10, #3a1020 40%, #281012);
        }
        /* Aurora */
        body.fullscreen-active.theme-aurora .fullscreen-theme-bg,
        body.fullscreen-active.theme-aurora .metronome-section .fs-theme-bg {
            background-image:
                radial-gradient(1200px 800px at 70% 20%, rgba(126,249,197,0.2), rgba(126,249,197,0) 60%),
                radial-gradient(1000px 700px at 20% 80%, rgba(139,92,246,0.18), rgba(139,92,246,0) 60%),
                linear-gradient(135deg, #08120f, #0a1c23 40%, #0c0f24);
        }

        /* Timer panel visibility: only in fullscreen */
        .timer-panel { display: none; }
        body.fullscreen-active .timer-panel {
            display: block;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1100;
            width: auto;
            min-width: 240px;
        }
        .bg-orbs .orb {
            position: absolute;
            width: 520px;
            height: 520px;
            filter: blur(60px);
            opacity: 0.25;
            border-radius: 50%;
            mix-blend-mode: screen;
            animation: drift 24s ease-in-out infinite alternate;
        }
        .bg-orbs .orb.orb1 {
            top: -120px; left: -120px;
            background: radial-gradient(circle at 30% 30%, #00d4ff, transparent 60%),
                        radial-gradient(circle at 70% 70%, #ff6b9d, transparent 60%);
        }
        .bg-orbs .orb.orb2 {
            bottom: -160px; right: -160px;
            background: radial-gradient(circle at 70% 30%, #ffd93d, transparent 60%),
                        radial-gradient(circle at 30% 70%, #8b5cf6, transparent 60%);
            animation-delay: 4s;
        }
        @keyframes drift {
            from { transform: translate3d(0,0,0) scale(1); }
            to { transform: translate3d(20px,-30px,0) scale(1.06); }
        }

        /* Minimal theme presets */
        .theme-sunset h1 {
            background: linear-gradient(135deg, #ff8a5b, #ff6b9d, #ffd93d);
            background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .theme-sunset .play-stop-btn { background: linear-gradient(135deg, #ff6b9d, #ff8a5b); }
        .theme-sunset .tempo-btn { background: linear-gradient(135deg, #ff6b9d, #ff8a5b); }

        .theme-aurora h1 {
            background: linear-gradient(135deg, #7ef9c5, #00d4ff, #8b5cf6);
            background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .theme-aurora .play-stop-btn { background: linear-gradient(135deg, #00d4ff, #8b5cf6); }
        .theme-aurora .tempo-btn { background: linear-gradient(135deg, #00d4ff, #8b5cf6); }

        /* Respect reduced motion */
        @media (prefers-reduced-motion: reduce) {
            * { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition: none !important; }
        }

        /* Fullscreen layout */
        body.fullscreen-active .header { display: none; }
        body.fullscreen-active .main-grid { grid-template-columns: 1fr; }
        body.fullscreen-active .controls-panel { display: none; }
        body.fullscreen-active .metronome-section { padding: 60px; }
        body.fullscreen-active .visual-metronome { height: 420px; }
        body.fullscreen-active .bpm-value { font-size: 5.2rem; text-shadow: 0 0 30px rgba(0,212,255,0.6); }
        body.fullscreen-active .beat-dot { width: 20px; height: 20px; }
        body.fullscreen-active .bg-orbs { opacity: 0.9; }

        /* Fullscreen toggle */
        .fullscreen-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.18);
            color: #fff;
            border-radius: 12px;
            padding: 10px 14px;
            cursor: pointer;
            backdrop-filter: blur(6px);
            box-shadow: 0 10px 24px rgba(0,0,0,0.35);
        }
        .fullscreen-toggle:hover { background: rgba(255,255,255,0.14); }

        /* Practice timer */
        .timer { display: flex; flex-direction: column; align-items: center; gap: 10px; margin: 10px 0 30px 0; }
        .timer-display {
            font-variant-numeric: tabular-nums;
            font-size: 1.4rem;
            letter-spacing: 1px;
            color: #e2e8f0;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            padding: 8px 14px;
            border-radius: 10px;
        }
        .timer-controls { display: flex; gap: 10px; }
        .timer-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .timer-btn:hover { background: rgba(255,255,255,0.18); }
    </style>
</head>
<body>
    <div class="bg-orbs">
        <div class="orb orb1"></div>
        <div class="orb orb2"></div>
    </div>
    <div class="container">
        <!-- Fullscreen toggle -->
        <button class="fullscreen-toggle" id="fullscreenBtn" aria-label="Enter fullscreen" title="Fullscreen" onclick="toggleFullscreen()">⤢ Fullscreen</button>
        <div class="fullscreen-theme-bg"></div>
        <!-- Mobile controls toggle -->
        <button class="mobile-controls-toggle" onclick="toggleMobileControls()" aria-label="Open metronome controls">
            ⚙️
        </button>
        
        <!-- Mobile overlay -->
        <div class="mobile-overlay" onclick="closeMobileControls()"></div>
        
        <div class="header">
            <h1>Professional Piano Metronome</h1>
            <p class="subtitle">Advanced rhythm training for musicians</p>
        </div>

        <div class="main-grid">
            <div class="metronome-section card-3d">
                <div class="tempo-display">
                    <div class="bpm-value" id="bpmDisplay">120</div>
                    <div class="bpm-label">BPM</div>
                </div>

                <div class="visual-metronome">
                    <div class="pendulum-container">
                        <div class="fs-theme-bg"></div>
                        <div class="pendulum-glow"></div>
                        <div class="pendulum" id="pendulum">
                            <div class="pendulum-bob"></div>
                        </div>
                    </div>
                </div>

                <div class="beat-indicator" id="beatIndicator">
                    <div class="beat-dot"></div>
                    <div class="beat-dot"></div>
                    <div class="beat-dot"></div>
                    <div class="beat-dot"></div>
                </div>

                <div class="tempo-controls">
                    <button id="tempoDown" class="tempo-btn" onclick="adjustTempo(-5)">−</button>
                    <input type="range" class="tempo-slider" id="tempoSlider" min="40" max="500" value="120">
                    <input type="number" class="tempo-input" id="tempoInput" min="40" max="500" value="120" aria-label="Tempo input">
                    <button id="tempoUp" class="tempo-btn" onclick="adjustTempo(5)">+</button>
                </div>

                <button class="play-stop-btn" id="playStopBtn" onclick="toggleMetronome()">START</button>
            </div>

            <div class="side-column">
            <div class="controls-panel card-3d">
                <div class="control-group">
                    <label class="control-label">Theme</label>
                    <div class="theme-group" role="tablist" aria-label="Theme selector">
                        <button class="theme-option theme-ocean selected" role="tab" aria-selected="true" onclick="setTheme('ocean')">
                            <span class="icon">🌊</span><span>Ocean</span>
                        </button>
                        <button class="theme-option theme-sunset" role="tab" aria-selected="false" onclick="setTheme('sunset')">
                            <span class="icon">🌇</span><span>Sunset</span>
                        </button>
                        <button class="theme-option theme-aurora" role="tab" aria-selected="false" onclick="setTheme('aurora')">
                            <span class="icon">🌌</span><span>Aurora</span>
                        </button>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">Time Signature</label>
                    <div class="control-select-wrapper">
                    <select class="control-select" id="timeSignature">
                        <option value="4/4">4/4</option>
                        <option value="3/4">3/4</option>
                        <option value="2/4">2/4</option>
                        <option value="6/8">6/8</option>
                        <option value="9/8">9/8</option>
                        <option value="12/8">12/8</option>
                        <option value="5/4">5/4</option>
                        <option value="7/8">7/8</option>
                    </select>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">Subdivisions</label>
                    <div class="subdivision-grid">
                        <button class="subdivision-btn active" data-subdivision="quarter">♩ Quarter</button>
                        <button class="subdivision-btn" data-subdivision="eighth">♫ Eighth</button>
                        <button class="subdivision-btn" data-subdivision="triplet">♫♫♫ Triplet</button>
                        <button class="subdivision-btn" data-subdivision="sixteenth">♬ Sixteenth</button>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">Sound</label>
                    <div class="control-select-wrapper">
                    <select class="control-select" id="soundSelect">
                        <option value="classic">Classic Click</option>
                        <option value="wood">Wood Block</option>
                        <option value="digital">Digital Beep</option>
                        <option value="rimshot">Rimshot</option>
                        <option value="clave">Clave</option>
                        <option value="hihat">Hi‑Hat</option>
                        <option value="shaker">Shaker</option>
                        <option value="stick">Stick</option>
                        <option value="tick">Tick</option>
                        <option value="snap">Snap</option>
                    </select>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">Volume</label>
                    <input type="range" class="control-input" id="volumeSlider" min="0" max="100" value="70">
                </div>

                <button class="tap-tempo-btn" onclick="tapTempo()">TAP TEMPO</button>

                <div class="control-group">
                    <label class="control-label">Accent Pattern</label>
                    <div class="accent-pattern" id="accentPattern"></div>
                    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="preset-btn" onclick="setAccentMode('single')">Single</button>
                        <button class="preset-btn" onclick="setAccentMode('double')">Double</button>
                        <button class="preset-btn" onclick="setAccentMode('triple')">Triple</button>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">Presets</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" class="control-input" id="presetName" placeholder="Preset name">
                        <button class="preset-btn" onclick="savePreset()">Save</button>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <div class="control-select-wrapper" style="flex:1;">
                            <select class="control-select" id="presetList"></select>
                        </div>
                        <button class="preset-btn" onclick="loadPreset()">Load</button>
                    </div>
                </div>

                <div class="advanced-section">
                    <div class="control-group">
                        <label class="control-label">Keyboard Shortcuts</label>
                        <div style="font-size: 0.85rem; color: #b8bcc8; line-height: 1.4;">
                            <div><strong>Space:</strong> Start/Stop</div>
                            <div><strong>↑/↓:</strong> Fine tempo (±1)</div>
                            <div><strong>←/→:</strong> Coarse tempo (±5)</div>
                            <div><strong>T, Q, W, E, R, Enter:</strong> Tap tempo</div>
                            <div style="margin-top: 8px; font-size: 0.8rem; opacity: 0.8;">
                                On mobile: Tap the gear icon to access controls
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">Tempo Presets</label>
                        <div class="tempo-presets">
                            <button class="tempo-preset-btn" onclick="setTempo(60)">Largo (60)</button>
                            <button class="tempo-preset-btn" onclick="setTempo(76)">Adagio (76)</button>
                            <button class="tempo-preset-btn" onclick="setTempo(108)">Andante (108)</button>
                            <button class="tempo-preset-btn" onclick="setTempo(120)">Moderato (120)</button>
                            <button class="tempo-preset-btn" onclick="setTempo(144)">Allegro (144)</button>
                            <button class="tempo-preset-btn" onclick="setTempo(180)">Presto (180)</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Polyrhythm</label>
                        <div class="polyrhythm-controls">
                            <input type="number" class="control-input" id="polyLeft" placeholder="3" min="2" max="16">
                            <input type="number" class="control-input" id="polyRight" placeholder="4" min="2" max="16">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timer panel separate on desktop -->
            <div class="timer-panel card-3d">
                <div class="control-label" style="margin-bottom:10px;">Practice Timer</div>
                <div class="timer">
                    <div class="timer-display" id="timerDisplay">00:00:00</div>
                    <div class="timer-controls">
                        <button class="timer-btn" id="timerStart" onclick="startPracticeTimer()">Start</button>
                        <button class="timer-btn" id="timerPause" onclick="pausePracticeTimer()">Pause</button>
                        <button class="timer-btn" id="timerReset" onclick="resetPracticeTimer()">Reset</button>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <script>
        class ProfessionalMetronome {
            constructor() {
                this.isPlaying = false;
                this.bpm = 120;
                this.currentBeat = 0;
                this.beatsPerMeasure = 4;
                this.subdivision = 'quarter';
                this.accentPattern = [true, false, false, false];
                this.volume = 0.7;
                this.sound = 'classic';
                this.audioContext = null;
                this.nextNoteTime = 0.0;
                this.scheduleAheadTime = 25.0;
                this.lookAhead = 25.0;
                this.timerInterval = null;
                this.tapTimes = [];
                
                this.initializeAudio();
                this.initializeTimer();
                this.setupEventListeners();
                this.updateBeatIndicator();
                this.updateAccentPattern();
                // Initialize UI reflectors
                this.setTempo(this.bpm);
            }

            initializeAudio() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            initializeTimer() {
                // Use setInterval instead of Worker for better compatibility
                this.timerInterval = null;
            }

            createSound(frequency = 800, duration = 0.1, type = 'sine', pan = 0, detuneCents = 0) {
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                const panner = this.audioContext.createStereoPanner ? this.audioContext.createStereoPanner() : null;
                
                oscillator.connect(gainNode);
                if (panner) {
                    gainNode.connect(panner);
                    panner.connect(this.audioContext.destination);
                    panner.pan.setValueAtTime(pan, this.audioContext.currentTime);
                } else {
                    gainNode.connect(this.audioContext.destination);
                }
                
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = type;
                if (oscillator.detune) {
                    oscillator.detune.setValueAtTime(detuneCents, this.audioContext.currentTime);
                }
                
                // Click envelope for clear transient, quick decay
                const t0 = this.audioContext.currentTime;
                gainNode.gain.setValueAtTime(0, t0);
                gainNode.gain.linearRampToValueAtTime(this.volume, t0 + 0.005);
                gainNode.gain.exponentialRampToValueAtTime(0.0008, t0 + duration);
                
                oscillator.start(t0);
                oscillator.stop(t0 + duration);
            }

            playSound(isAccent = false) {
                // Curated metronome timbres (psychoacoustically snappy, dopamine-friendly yet not fatiguing)
                const soundSettings = {
                    classic:   { freq: isAccent ? 1200 : 900, duration: 0.045, type: 'square' },
                    wood:      { freq: isAccent ? 550 : 350,  duration: 0.06,  type: 'triangle' },
                    digital:   { freq: isAccent ? 1400 : 950, duration: 0.04,  type: 'square' },
                    rimshot:   { freq: isAccent ? 420 : 280,  duration: 0.035, type: 'sawtooth' },
                    clave:     { freq: isAccent ? 800 : 600,  duration: 0.07,  type: 'triangle' },
                    hihat:     { freq: isAccent ? 9000: 8000, duration: 0.02,  type: 'square' },
                    shaker:    { freq: isAccent ? 6000: 5000, duration: 0.05,  type: 'triangle' },
                    stick:     { freq: isAccent ? 1000: 700,  duration: 0.05,  type: 'square' },
                    tick:      { freq: isAccent ? 1800: 1300, duration: 0.03,  type: 'square' },
                    snap:      { freq: isAccent ? 2200: 1600, duration: 0.045, type: 'square' }
                };

                const settings = soundSettings[this.sound] || soundSettings.classic;
                // Subtle stereo and micro-detune for non-fatiguing variation
                const pan = isAccent ? 0 : (Math.random() < 0.5 ? -0.12 : 0.12);
                const detune = isAccent ? 0 : (Math.random() * 6 - 3); // ±3 cents
                this.createSound(settings.freq, settings.duration, settings.type, pan, detune);
            }

            scheduler() {
                while (this.nextNoteTime < this.audioContext.currentTime + this.scheduleAheadTime / 1000.0) {
                    this.scheduleNote(this.nextNoteTime);
                    this.nextNote();
                }
            }

            scheduleNote(time) {
                const scheduledBeat = this.currentBeat;
                const isAccent = this.accentPattern[scheduledBeat % this.accentPattern.length];

                // Schedule with precise AudioContext timing
                const delayMs = Math.max(0, (time - this.audioContext.currentTime) * 1000);
                setTimeout(() => {
                    // Guard if stopped
                    if (!this.isPlaying) return;
                    this.playSound(isAccent);
                    this.updateVisualFeedbackPrecise(scheduledBeat);
                }, delayMs);
            }

            nextNote() {
                const secondsPerBeat = 60.0 / this.bpm;
                let step = 1; // beats-per-measure step at current subdivision
                switch(this.subdivision) {
                    case 'eighth': step = 0.5; break;
                    case 'triplet': step = 1/3; break;
                    case 'sixteenth': step = 0.25; break;
                }
                this.nextNoteTime += secondsPerBeat * step;
                // Only advance visible beat on whole steps
                if (Math.abs((this.currentBeat + 1) - Math.round(this.currentBeat + 1)) < 1e-9 || step === 1) {
                    this.currentBeat++;
                } else {
                    this.currentBeat += step;
                }
            }

            updateVisualFeedbackPrecise(targetBeat) {
                // Beat dots
                const beatDots = document.querySelectorAll('.beat-dot');
                const activeIndex = targetBeat % this.beatsPerMeasure;
                beatDots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === activeIndex);
                    dot.classList.toggle('accent', !!this.accentPattern[index]);
                    if (index === activeIndex) {
                        dot.classList.add('pulse');
                        setTimeout(() => dot.classList.remove('pulse'), 180);
                    }
                });

                // BPM ripple + flash
                const tempoDisplay = document.querySelector('.tempo-display');
                if (tempoDisplay) {
                    const ripple = document.createElement('div');
                    ripple.className = 'bpm-ripple';
                    tempoDisplay.appendChild(ripple);
                    setTimeout(() => ripple.remove(), 700);
                    const card = document.querySelector('.metronome-section');
                    card.classList.add('beat-flash');
                    setTimeout(() => card.classList.remove('beat-flash'), 120);
                }

                // Pendulum continuous swing blended with snap: set interval based on BPM
                const pendulum = document.getElementById('pendulum');
                const angle = targetBeat % 2 === 0 ? 20 : -20;
                const msPerBeat = 60000 / this.bpm;
                const half = msPerBeat / 2;
                pendulum.style.transition = `transform ${Math.max(40, half - 10)}ms cubic-bezier(.2,.9,.3,1)`;
                pendulum.style.transform = `translateX(-50%) rotate(${angle}deg)`;
            }

            start() {
                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
                
                this.isPlaying = true;
                this.currentBeat = 0;
                this.nextNoteTime = this.audioContext.currentTime;
                
                // Start the scheduler with requestAnimationFrame for better performance
                this.scheduleLoop();
                
                document.getElementById('playStopBtn').textContent = 'STOP';
                document.getElementById('playStopBtn').classList.add('playing');
            }

            scheduleLoop() {
                if (this.isPlaying) {
                    this.scheduler();
                    // Use setTimeout for consistent timing, fallback to requestAnimationFrame
                    setTimeout(() => this.scheduleLoop(), 25);
                }
            }

            stop() {
                this.isPlaying = false;
                
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
                
                document.getElementById('playStopBtn').textContent = 'START';
                document.getElementById('playStopBtn').classList.remove('playing');
                
                // Reset visual indicators
                document.querySelectorAll('.beat-dot').forEach(dot => {
                    dot.classList.remove('active', 'accent');
                });
                
                document.getElementById('pendulum').style.transform = 'translateX(-50%) rotate(0deg)';
            }

            setTempo(newTempo) {
                this.bpm = Math.max(40, Math.min(500, newTempo));
                document.getElementById('bpmDisplay').textContent = this.bpm;
                document.getElementById('tempoSlider').value = this.bpm;
                const tempoInput = document.getElementById('tempoInput');
                if (tempoInput) tempoInput.value = this.bpm;
                // Disable −/+ at bounds
                const down = document.getElementById('tempoDown');
                const up = document.getElementById('tempoUp');
                if (down) down.disabled = this.bpm <= 40;
                if (up) up.disabled = this.bpm >= 500;
            }

            setTimeSignature(signature) {
                const [beats, noteValue] = signature.split('/').map(Number);
                this.beatsPerMeasure = beats;
                this.updateBeatIndicator();
                this.updateAccentPattern();
            }

            updateBeatIndicator() {
                const indicator = document.getElementById('beatIndicator');
                indicator.innerHTML = '';
                
                for (let i = 0; i < this.beatsPerMeasure; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'beat-dot';
                    indicator.appendChild(dot);
                }
            }

            updateAccentPattern() {
                if (!this.accentMode) this.accentMode = 'single';
                this.accentPattern = new Array(this.beatsPerMeasure).fill(false);
                // Modes: single (1 strong), double (1 strong, mid weak), triple (1 strong, 2 weak)
                if (this.accentMode === 'single') {
                    this.accentPattern[0] = true;
                } else if (this.accentMode === 'double') {
                    this.accentPattern[0] = true;
                    this.accentPattern[Math.floor(this.beatsPerMeasure/2)] = true;
                } else if (this.accentMode === 'triple') {
                    this.accentPattern[0] = true;
                    this.accentPattern[Math.floor(this.beatsPerMeasure/3)] = true;
                    this.accentPattern[Math.floor(2*this.beatsPerMeasure/3)] = true;
                }
                
                const patternDiv = document.getElementById('accentPattern');
                patternDiv.innerHTML = '';
                
                for (let i = 0; i < this.beatsPerMeasure; i++) {
                    const beat = document.createElement('div');
                    beat.className = 'accent-beat';
                    beat.textContent = i + 1;
                    if (this.accentPattern[i]) {
                        beat.classList.add('accent');
                    }
                    
                    beat.addEventListener('click', () => {
                        this.accentPattern[i] = !this.accentPattern[i];
                        beat.classList.toggle('accent');
                    });
                    
                    patternDiv.appendChild(beat);
                }
            }

            setupEventListeners() {
                // Tempo slider
                document.getElementById('tempoSlider').addEventListener('input', (e) => {
                    this.setTempo(parseInt(e.target.value));
                });
                const tempoInput = document.getElementById('tempoInput');
                if (tempoInput) {
                    tempoInput.addEventListener('input', (e) => {
                        const v = parseInt(e.target.value || 0);
                        if (!isNaN(v)) this.setTempo(v);
                    });
                }

                // Time signature
                document.getElementById('timeSignature').addEventListener('change', (e) => {
                    this.setTimeSignature(e.target.value);
                });

                // Subdivisions
                document.querySelectorAll('.subdivision-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.subdivision-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.subdivision = e.target.dataset.subdivision;
                    });
                });

                // Sound selection
                document.getElementById('soundSelect').addEventListener('change', (e) => {
                    this.sound = e.target.value;
                });

                // Volume control
                document.getElementById('volumeSlider').addEventListener('input', (e) => {
                    this.volume = e.target.value / 100;
                });

                // Polyrhythm controls
                document.getElementById('polyLeft').addEventListener('input', (e) => {
                    this.setupPolyrhythm();
                });

                document.getElementById('polyRight').addEventListener('input', (e) => {
                    this.setupPolyrhythm();
                });
            }

            setupPolyrhythm() {
                const left = parseInt(document.getElementById('polyLeft').value) || 3;
                const right = parseInt(document.getElementById('polyRight').value) || 4;
                
                // Calculate LCM for polyrhythm pattern
                const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                const lcm = (a, b) => (a * b) / gcd(a, b);
                
                const patternLength = lcm(left, right);
                this.polyrhythmPattern = [];
                
                for (let i = 0; i < patternLength; i++) {
                    const leftHit = i % (patternLength / left) === 0;
                    const rightHit = i % (patternLength / right) === 0;
                    this.polyrhythmPattern.push({ left: leftHit, right: rightHit });
                }
            }

            tapTempo() {
                const now = Date.now();
                this.tapTimes.push(now);
                
                // Keep only last 4 taps
                if (this.tapTimes.length > 4) {
                    this.tapTimes.shift();
                }
                
                if (this.tapTimes.length >= 2) {
                    const intervals = [];
                    for (let i = 1; i < this.tapTimes.length; i++) {
                        intervals.push(this.tapTimes[i] - this.tapTimes[i-1]);
                    }
                    
                    const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;
                    const newBpm = Math.round(60000 / avgInterval);
                    
                    if (newBpm >= 40 && newBpm <= 500) {
                        this.setTempo(newBpm);
                    }
                }
                
                // Clear taps after 3 seconds of inactivity
                setTimeout(() => {
                    const timeSinceLastTap = Date.now() - now;
                    if (timeSinceLastTap >= 3000) {
                        this.tapTimes = [];
                    }
                }, 3000);
            }

            savePreset() {
                const preset = {
                    bpm: this.bpm,
                    timeSignature: document.getElementById('timeSignature').value,
                    subdivision: this.subdivision,
                    sound: this.sound,
                    volume: this.volume,
                    accentPattern: [...this.accentPattern]
                };
                
                const input = document.getElementById('presetName');
                const name = input && input.value ? input.value.trim() : '';
                if (!name) {
                    alert('Enter a preset name');
                    return;
                }
                localStorage.setItem(`metronome-preset-${name}`, JSON.stringify(preset));
                this.refreshPresetList(name);
                alert('Preset saved successfully!');
            }

            loadPreset() {
                const list = document.getElementById('presetList');
                const name = list && list.value ? list.value : '';
                if (!name) { alert('Choose a preset to load'); return; }
                const presetData = localStorage.getItem(`metronome-preset-${name}`);
                if (!presetData) { alert('Preset not found!'); return; }
                const preset = JSON.parse(presetData);

                this.setTempo(preset.bpm);
                document.getElementById('timeSignature').value = preset.timeSignature;
                this.setTimeSignature(preset.timeSignature);
                this.subdivision = preset.subdivision;
                this.sound = preset.sound;
                this.volume = preset.volume;

                document.getElementById('soundSelect').value = preset.sound;
                document.getElementById('volumeSlider').value = preset.volume * 100;

                document.querySelectorAll('.subdivision-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.subdivision === preset.subdivision) {
                        btn.classList.add('active');
                    }
                });
                alert('Preset loaded successfully!');
            }

            refreshPresetList(selectName = '') {
                const list = document.getElementById('presetList');
                if (!list) return;
                const keys = Object.keys(localStorage).filter(k => k.startsWith('metronome-preset-'))
                    .map(k => k.replace('metronome-preset-', ''))
                    .sort((a, b) => a.localeCompare(b));
                list.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'Select preset';
                list.appendChild(placeholder);
                keys.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    if (name === selectName) opt.selected = true;
                    list.appendChild(opt);
                });
            }
        }

        // Global functions
        let metronome;
        let isFullscreen = false;

        function initializeMetronome() {
            metronome = new ProfessionalMetronome();
        }

        function toggleMetronome() {
            if (!metronome) {
                initializeMetronome();
            }
            
            if (metronome.isPlaying) {
                metronome.stop();
            } else {
                metronome.start();
            }
        }

        function adjustTempo(change) {
            if (!metronome) {
                initializeMetronome();
            }
            metronome.setTempo(metronome.bpm + change);
        }

        function setTempo(bpm) {
            if (!metronome) {
                initializeMetronome();
            }
            metronome.setTempo(bpm);
        }

        function setAccentMode(mode) {
            if (!metronome) initializeMetronome();
            metronome.accentMode = mode;
            metronome.updateAccentPattern();
        }

        function tapTempo() {
            if (!metronome) {
                initializeMetronome();
            }
            metronome.tapTempo();
        }

        function savePreset() {
            if (!metronome) {
                initializeMetronome();
            }
            metronome.savePreset();
        }

        function loadPreset() {
            if (!metronome) {
                initializeMetronome();
            }
            metronome.loadPreset();
        }

        function setTheme(name) {
            document.body.classList.remove('theme-sunset', 'theme-aurora');
            if (name === 'sunset') document.body.classList.add('theme-sunset');
            if (name === 'aurora') document.body.classList.add('theme-aurora');
            // Update segmented control selected state
            document.querySelectorAll('.theme-option').forEach(btn => {
                const isSelected = btn.classList.contains(`theme-${name}`);
                btn.classList.toggle('selected', isSelected);
                btn.setAttribute('aria-selected', isSelected ? 'true' : 'false');
            });
        }

        // Fullscreen controls
        function enterFullscreen() {
            const elem = document.querySelector('.metronome-section');
            if (elem.requestFullscreen) elem.requestFullscreen();
            else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
            document.body.classList.add('fullscreen-active');
            const btn = document.getElementById('fullscreenBtn');
            if (btn) btn.textContent = '⤡ Exit';
            isFullscreen = true;
        }
        function exitFullscreen() {
            if (document.exitFullscreen) document.exitFullscreen();
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
            document.body.classList.remove('fullscreen-active');
            const btn = document.getElementById('fullscreenBtn');
            if (btn) btn.textContent = '⤢ Fullscreen';
            isFullscreen = false;
        }
        function toggleFullscreen() { if (!isFullscreen) enterFullscreen(); else exitFullscreen(); }
        document.addEventListener('fullscreenchange', () => {
            const fs = !!document.fullscreenElement;
            if (!fs) document.body.classList.remove('fullscreen-active');
            const btn = document.getElementById('fullscreenBtn');
            if (btn) btn.textContent = fs ? '⤡ Exit' : '⤢ Fullscreen';
            isFullscreen = fs;
        });

        // Practice timer controls
        let practiceTimerRunning = false;
        let practiceTimerStart = 0;
        let practiceTimerAccum = 0;
        let practiceTimerRAF = null;
        function formatHMS(ms) {
            const total = Math.floor(ms / 1000);
            const h = Math.floor(total / 3600).toString().padStart(2, '0');
            const m = Math.floor((total % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(total % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }
        function renderPracticeTimer() {
            const el = document.getElementById('timerDisplay');
            if (!el) return;
            let elapsed = practiceTimerAccum;
            if (practiceTimerRunning) elapsed += performance.now() - practiceTimerStart;
            el.textContent = formatHMS(elapsed);
        }
        function tickPracticeTimer() {
            renderPracticeTimer();
            if (practiceTimerRunning) practiceTimerRAF = requestAnimationFrame(tickPracticeTimer);
        }
        function startPracticeTimer() {
            if (practiceTimerRunning) return;
            practiceTimerRunning = true;
            practiceTimerStart = performance.now();
            tickPracticeTimer();
        }
        function pausePracticeTimer() {
            if (!practiceTimerRunning) return;
            practiceTimerRunning = false;
            practiceTimerAccum += performance.now() - practiceTimerStart;
            if (practiceTimerRAF) cancelAnimationFrame(practiceTimerRAF);
            renderPracticeTimer();
        }
        function resetPracticeTimer() {
            practiceTimerRunning = false;
            practiceTimerAccum = 0;
            practiceTimerStart = 0;
            if (practiceTimerRAF) cancelAnimationFrame(practiceTimerRAF);
            renderPracticeTimer();
        }

        function attachTilt(selector) {
            const els = document.querySelectorAll(selector);
            els.forEach(el => {
                const damp = 8; // toned down for practicality
                const reset = () => el.style.transform = '';
                el.addEventListener('mousemove', (e) => {
                    const r = el.getBoundingClientRect();
                    const x = (e.clientX - r.left) / r.width;   // 0..1
                    const y = (e.clientY - r.top) / r.height;   // 0..1
                    const rx = (0.5 - y) * damp;
                    const ry = (x - 0.5) * damp;
                    el.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg) translateZ(0)`;
                });
                el.addEventListener('mouseleave', reset);
            });
        }

        // Mobile controls functions
        function toggleMobileControls() {
            const panel = document.querySelector('.controls-panel');
            const overlay = document.querySelector('.mobile-overlay');
            const button = document.querySelector('.mobile-controls-toggle');
            
            if (panel.classList.contains('open')) {
                closeMobileControls();
            } else {
                panel.classList.add('open');
                overlay.classList.add('active');
                button.style.left = '320px';
            }
        }

        function closeMobileControls() {
            const panel = document.querySelector('.controls-panel');
            const overlay = document.querySelector('.mobile-overlay');
            const button = document.querySelector('.mobile-controls-toggle');
            
            panel.classList.remove('open');
            overlay.classList.remove('active');
            button.style.left = '20px';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Add click handlers for tempo preset buttons
            document.querySelectorAll('.tempo-preset-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const bpm = parseInt(e.target.textContent.match(/\d+/)[0]);
                    setTempo(bpm);
                });
            });

            // Add visual feedback for button interactions
            document.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.target.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        e.target.style.transform = '';
                    }, 150);
                });
            });

            // Add keyboard shortcuts
            let shortcutsEnabled = true;
            document.addEventListener('keydown', (e) => {
                if (!shortcutsEnabled) return;
                // Prevent default only for our shortcuts
                switch(e.code) {
                    case 'Space':
                        e.preventDefault();
                        toggleMetronome();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        adjustTempo(1);
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        adjustTempo(-1);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        adjustTempo(5);
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        adjustTempo(-5);
                        break;
                    case 'KeyT':
                        if (!e.ctrlKey && !e.altKey && !e.metaKey) {
                            e.preventDefault();
                            tapTempo();
                        }
                        break;
                    case 'KeyQ':
                        if (!e.ctrlKey && !e.altKey && !e.metaKey) {
                            e.preventDefault();
                            tapTempo();
                        }
                        break;
                    case 'KeyW':
                        if (!e.ctrlKey && !e.altKey && !e.metaKey) {
                            e.preventDefault();
                            tapTempo();
                        }
                        break;
                    case 'KeyE':
                        if (!e.ctrlKey && !e.altKey && !e.metaKey) {
                            e.preventDefault();
                            tapTempo();
                        }
                        break;
                    case 'KeyR':
                        if (!e.ctrlKey && !e.altKey && !e.metaKey) {
                            e.preventDefault();
                            tapTempo();
                        }
                        break;
                    case 'Enter':
                        if (!e.ctrlKey && !e.altKey && !e.metaKey) {
                            e.preventDefault();
                            tapTempo();
                        }
                        break;
                    case 'Escape':
                        if (window.innerWidth <= 768) {
                            closeMobileControls();
                        }
                        break;
                }
            });

            // Add visual feedback for tap tempo keys
            const tapKeys = ['KeyT', 'KeyQ', 'KeyW', 'KeyE', 'KeyR', 'Enter'];
            document.addEventListener('keydown', (e) => {
                if (!shortcutsEnabled) return;
                if (tapKeys.includes(e.code)) {
                    const tapButton = document.querySelector('.tap-tempo-btn');
                    if (tapButton) {
                        tapButton.style.transform = 'scale(0.95)';
                        tapButton.style.background = 'linear-gradient(135deg, #ff6b9d, #ffd93d)';
                    }
                }
            });

            document.addEventListener('keyup', (e) => {
                if (!shortcutsEnabled) return;
                if (tapKeys.includes(e.code)) {
                    const tapButton = document.querySelector('.tap-tempo-btn');
                    if (tapButton) {
                        setTimeout(() => {
                            tapButton.style.transform = '';
                            tapButton.style.background = '';
                        }, 150);
                    }
                }
            });

            // Disable shortcuts when typing in inputs/selects
            const focusables = document.querySelectorAll('input, select, textarea');
            focusables.forEach(el => {
                el.addEventListener('focus', () => { shortcutsEnabled = false; });
                el.addEventListener('blur', () => { shortcutsEnabled = true; });
            });

            // Initialize the metronome
            initializeMetronome();
            attachTilt('.card-3d');
            if (metronome && metronome.refreshPresetList) {
                metronome.refreshPresetList();
            }
        });

        // Handle visibility change to pause when tab is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && metronome && metronome.isPlaying) {
                // Optionally pause when tab is hidden
                // metronome.stop();
            }
        });
        // Register service worker for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {});
            });
        }
    </script>
</body>
</html>